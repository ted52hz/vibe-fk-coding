<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Mobile Screen Event Diagram (Events inside Screen box)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    html,body {background: #eaf0fb; font-family: 'Montserrat', Arial, sans-serif; color: #26324B; margin: 0;}
    .container { max-width: 1200px; margin: 24px auto 20px;}
    .flexrow { display: flex; align-items: flex-start; justify-content: center; gap: 45px;}
    .panel { min-width: 295px; max-width: 400px; background: #fff; border-radius: 12px; box-shadow: 0 2px 26px #79899a19; padding: 17px 18px 15px 18px;}
    h1 { margin-top: 2px; font-size: 1.26rem; font-weight: bold; letter-spacing: -.5px; }
    label { font-size: 1.06em; }
    textarea { width: 100%; min-height: 68px; font-size: 1.02em; resize: vertical; padding: 7px; margin: 6px 0 9px 0;}
    button, .csv-btn, .small-btn {
      background: #296eff; color: #fff; border: none; font-size: 1.01em;
      font-family: inherit; padding: 7px 16px; border-radius: 7px; cursor: pointer;
      margin: 4px 11px 7px 0; outline: none; transition: background .2s;
    }
    button:active,.csv-btn:active{background:#1846a7;}
    button:disabled, .small-btn:disabled {background: #bed2fa;color:#678;}
    .csv-btn, label[for="csvInput"]{display:inline-block;}
    input[type="file"]{display:none;}
    .file-name {font-size:0.96em;color:#5a709b;}
    .error-msg {color: #db3434;font-size:0.98em;}
    .hint {font-size: 0.98em; color: #6192cb;}
    .mobile-phone-frame {
      background: linear-gradient(105deg, #e8e6fd 60%, #d4edff 98%);
      width: 340px; min-width: 180px; height: 675px; padding: 19px 17px 24px 17px;
      border-radius: 29px; box-shadow: 0 9px 52px #4d77ff10,0 1.5px 0px #e2eaff;
      display: flex; align-items: center; justify-content: center; z-index: 3; position: relative;
    }
    .mobile-bezell {position: absolute; left: 50%; width: 80px; height: 9px; background: #dbdeef; top: 11px;
      border-radius:13px; transform:translateX(-50%); z-index:10;}
    .mobile-screen {
      width: 300px; min-width: 150px; height: 630px; background: #fff; border-radius: 24px; box-shadow: 0 1.5px 10px #aaaaef18;
      overflow: hidden; position: relative; display: flex; flex-direction: column; justify-content: flex-start; animation: fadeScreen 0.47s;
    }
    @keyframes fadeScreen {from { opacity: 0; transform: scale(0.97);} to   { opacity: 1; transform: none;}}
    .app-header {width:100%;background: #296eff; color:#fff; font-weight:600; text-align:center; letter-spacing:0.5px; padding:13px 0 9px 0; font-size: 1.15em;
      border-top-left-radius: 24px; border-top-right-radius: 24px; position:relative; box-shadow:0 1.5px 0 #d1e8fa; z-index:2;}
    .app-header .stepbadge {background: #fff2; color: #fff; font-size: 0.97em; margin-left: 8px; border-radius: 9px; padding: 2.5px 8px; font-weight: 500;letter-spacing: .1px;}
    .screen-content {
      flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; min-height:340px; padding:22px 10px 40px 10px; font-size: 1.10em;
      animation: fadeIn .52s; z-index:2; position:relative; background: #ecf2ff;
    }
    @keyframes fadeIn {from { opacity:0; transform: translateY(30px);}to { opacity: 1; transform: none;}}
    .screen-title {
      font-size: 1.23em; font-weight: 700; color: #296eff; margin: 35px 0 15px 0; letter-spacing: -.5px; text-shadow: 0 1px 16px #e7e7ff3f;
    }
    .event-btn {margin-top: 32px; padding: 18px 38px; background: linear-gradient(89deg,#ffbe3b 60%, #ffd25b 120%);
      color: #26324B; font-weight: 700; border: none; border-radius: 12px; box-shadow: 0 3px 16px #ffe69947;
      font-size: 1.09em; letter-spacing: .8px; cursor: pointer; outline: none;transition: background 0.19s, box-shadow 0.19s;}
    .event-btn:active {background: linear-gradient(90deg,#f6a706 70%, #ffe246 120%);}
    .event-info {margin-top: 20px; color: #517db6; font-size: 0.99em;}
    .flow-controls {position: absolute; bottom: 15px; left: 0;right:0;display:flex;justify-content:center;gap:6px;z-index:3;}
    .small-btn {background: #f3f7ff; color: #296eff; font-size: 0.96em; font-weight: 600; padding: 5px 14px; margin: 0; border-radius: 8px;
      border:1.4px solid #d3eaff; box-shadow:0 1px 1.5px #eee6; outline: none; cursor: pointer; transition: background .18s;}
    .small-btn.active, .small-btn:hover {background: #eef5ff;}
    .small-btn:disabled {background:#ecedee;color:#b0bcd7;}
    .progress-bar-bg {width:88%; margin:10px auto 0 auto; height:8px; border-radius:8px;background:#dbe9fe;overflow:hidden;}
    .progress-bar-inner {height:100%; border-radius:7px;background:linear-gradient(90deg, #296eff 50%, #cfdcff 110%);transition: width 0.25s;}
    .graph-diagram-panel {min-width:350px;max-width:600px;width:100%;}
    .graph-box {margin: 0; border-radius: 12px;background: #f7faff;min-height:320px;padding:15px 0 0 0; max-width:570px;}
    .diagram-legend {
      font-size: 0.97em;color:#64669a;margin:7px 0 3px 12px;padding-bottom:3px;
    }
    @media (max-width:1200px) {.flexrow{gap:16px;}.panel{max-width:99vw}.graph-diagram-panel{max-width:99vw;min-width:0;width:99vw;}}
    @media (max-width:950px) { .flexrow{flex-direction:column;align-items:center;}}
    @media (max-width:620px) {.panel,.graph-diagram-panel{padding:7px 2vw;}.mobile-phone-frame{width:99vw; min-width:120px;}}
    @media (max-width:450px){.mobile-phone-frame{width:97vw;}.mobile-screen{width:94vw;}}
  </style>
</head>
<body>
<div class="container">
  <div class="flexrow">
    <div class="panel">
      <h1>Nhập hành trình (screen,event)</h1>
      <form id="inputForm">
        <label for="dataInput">Mỗi dòng: <b>screen,event</b> &nbsp;(như: Home,ClickLogin)</label>
        <textarea id="dataInput" placeholder="screen1,event1&#10;screen2,event2"></textarea>
        <button type="submit">Bắt đầu mô phỏng</button>
        <button id="sampleBtn" type="button">Ví dụ mẫu</button>
      </form>
      <div style="margin:10px 0 5px 0;">
        <label for="csvInput" class="csv-btn">Chọn file CSV</label>
        <input type="file" id="csvInput" accept=".csv,text/csv" />
        <span class="file-name" id="csvFileName"></span>
      </div>
      <div class="hint">
        Mỗi dòng là <i>screen,event</i>.<br>Có thể nhập tay hoặc upload CSV (2 cột screen,event).
      </div>
      <div class="error-msg" id="errorMsg"></div>
      <div style="color:#539; margin-top:12px;font-size:0.98em;">
        <b>CSV mẫu:</b>
          <span style="white-space:pre-line;background:#f7f9fd;border-radius:7px;display:inline-block;padding:6px 7px 3px 9px;">screen,event
Home,OpenApp
Home,ClickSearch
Search,InputQuery
Search,Submit
Result,SelectItem
Detail,ScrollDown
Detail,ClickBack
Result,ClickBack
Home,Logout</span>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:22px;">
      <div class="mobile-phone-frame">
        <div class="mobile-bezell"></div>
        <div class="mobile-screen" id="appScreen"></div>
      </div>
      <div class="graph-diagram-panel">
        <div class="diagram-legend">
          <b>Sơ đồ Flow:</b>
          <span style="display:inline-block;background:#296eff;border-radius:7px;padding:2px 7px;color:#fff;">Screen</span>
          <span style="display:inline-block;background:#ffd93b;border-radius:7px;padding:2px 7px;color:#26324B;">Event</span>
          <span style="color:#296eff;">(Step sáng là bước hiện tại)</span>
        </div>
        <div class="graph-box" id="graphBox">
          <svg id="graphSVG" width="100%" height="330"></svg>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  // --- Parse và flow ---
  const dataInput = document.getElementById('dataInput');
  const errorMsg = document.getElementById('errorMsg');
  const form = document.getElementById('inputForm');
  const csvInput = document.getElementById("csvInput");
  const fileNameBox = document.getElementById("csvFileName");
  const appScreen = document.getElementById('appScreen');
  const graphSVG = document.getElementById('graphSVG');

  let flow = [];   // [{screen, event}]
  let step = 0;    // current index
  let playing = false, playTimer = null;

  // ---------- FLOW SIMULATOR ----------
  function parseInput(str) {
    const lines = str
      .split('\n')
      .map(l=>l.trim())
      .filter(l=>l && !l.startsWith('#'));
    const result = [];
    for(let i=0;i<lines.length;i++) {
      const parts = lines[i].split(',');
      if(parts.length!==2) throw new Error(`Dòng ${i+1} không hợp lệ. Định dạng: screen,event`);
      result.push({screen: parts[0].trim(), event: parts[1].trim()});
    }
    return result;
  }
  function renderScreen(idx) {
    if(!flow || flow.length===0|| idx<0) return;
    if(idx >= flow.length) idx = flow.length - 1;
    const {screen,event} = flow[idx];
    let nextScreenLabel = (flow[idx+1]) ? (flow[idx+1].screen) : '';
    let done = idx === flow.length-1;
    appScreen.innerHTML = `
      <div class="app-header">
        <span>ỨNG DỤNG DEMO</span>
        <span class="stepbadge">${idx+1}/${flow.length}</span>
      </div>
      <div class="screen-content">
        <div class="screen-title">Màn hình: <span style="color:#1836b3">${screen}</span></div>
        <button class="event-btn" id="eventBtn" ${done?'style="background:#ececec;color:#aaa;cursor:not-allowed;"':''}>
          ${event}
        </button>
        <div class="event-info">
          ${ done ? "<b>Flow kết thúc.</b>" :
              `Event này: <b>${event}</b><br>Sau đó chuyển sang màn hình: <b>${nextScreenLabel}</b>`
          }
        </div>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar-inner" style="width:${((idx+1)/flow.length*100).toFixed(1)}%"></div>
      </div>
      <div class="flow-controls">
        <button class="small-btn" id="btnPrev" ${idx===0 ? 'disabled':''} title="Trở về trước">&lt; Trước</button>
        <button class="small-btn" id="btnNext" ${done ? 'disabled':''} title="Tiếp theo">&gt; Tiếp</button>
        <button class="small-btn" id="btnPlay" ${playing||(done) ? 'disabled':''} title="Tua nhanh">▶️ Auto</button>
        <button class="small-btn" id="btnRestart" ${idx<=0?'disabled':''} title="Quay lại đầu">⟳ Đầu flow</button>
      </div>
    `;
    // Nút
    const btnNext = appScreen.querySelector("#btnNext");
    const btnPrev = appScreen.querySelector("#btnPrev");
    const btnRestart = appScreen.querySelector("#btnRestart");
    const btnPlay = appScreen.querySelector("#btnPlay");
    const eventBtn = appScreen.querySelector("#eventBtn");
    if (btnPrev) btnPrev.onclick = function(){step--;updateSync()};
    if (btnNext) btnNext.onclick = function(){step++;updateSync()};
    if (btnRestart) btnRestart.onclick = function(){step=0;updateSync()};
    if (eventBtn && !done) eventBtn.onclick = function(){step++;updateSync()};
    if (btnPlay) btnPlay.onclick = function(){playing = true;autoPlay();};
  }
  function updateSync() {
    clearTimeout(playTimer); playing = false;
    if(step < 0) step = 0;
    if(step >= flow.length) step = flow.length-1;
    renderScreen(step);
    drawGraph(flow, step);
  }
  function autoPlay() {
    if(step < flow.length-1) {
      step++; renderScreen(step); drawGraph(flow, step);
      playTimer = setTimeout(autoPlay, 700);
    } else {
      playing = false;
      renderScreen(step); drawGraph(flow, step);
    }
  }
  function stopPlaying(){playing=false;clearTimeout(playTimer);}
  form.onsubmit = function(e){
    e.preventDefault(); errorMsg.textContent = ''; fileNameBox.textContent='';
    stopPlaying();
    try {
      const data = parseInput(dataInput.value);
      if(data.length<1) throw new Error("Bạn cần nhập ít nhất 1 dòng!");
      flow = data; step = 0;
      updateSync();
    }catch(err){ errorMsg.textContent = err.message; showEmptyPhone(); drawGraph([],0);}
  }
  document.getElementById('sampleBtn').onclick = function(){
    dataInput.value = [
      "Home,OpenApp",
      "Home,ClickSearch",
      "Search,InputQuery",
      "Search,Submit",
      "Result,SelectItem",
      "Detail,ScrollDown",
      "Detail,ClickBack",
      "Result,ClickBack",
      "Home,Logout"
    ].join('\n');
    errorMsg.textContent=''; fileNameBox.textContent = '';
    stopPlaying();
    form.dispatchEvent(new Event('submit'));
  };
  csvInput.addEventListener("change", function(e) {
    const file = csvInput.files && csvInput.files[0];
    errorMsg.textContent = '';
    if (!file) return;
    fileNameBox.textContent = '📄 ' + file.name;
    stopPlaying();
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const csvText = ev.target.result;
        const lines = csvText.split("\n").map(l=>l.trim()).filter(l=>l);
        if(lines.length<1) throw Error("File CSV không có dữ liệu.");
        let fields = []; let startLine = 1;
        if (lines[0].toLowerCase().includes('screen') && lines[0].toLowerCase().includes('event')) {
          fields = lines[0].split(',').map(h=>h.trim().toLowerCase());
        } else {fields = ['screen','event']; startLine = 0;}
        let scIdx = fields.findIndex(f=>f=='screen'), evIdx = fields.findIndex(f=>f=='event');
        if(scIdx==-1 || evIdx==-1) throw Error("File CSV phải có 2 cột: screen,event");
        const result = [];
        for (let i=startLine; i<lines.length;i++) {
          let parts = lines[i].split(',');
          if(parts.length < Math.max(scIdx, evIdx)+1) continue;
          let scr = parts[scIdx].trim(),
              ev = parts[evIdx].trim();
          if(scr && ev) result.push({screen:scr, event:ev});
        }
        if(result.length===0) throw Error("Không tìm thấy dữ liệu hợp lệ trong file CSV.");
        dataInput.value = result.map(c=>`${c.screen},${c.event}`).join('\n');
        flow = result; step = 0; updateSync();
      } catch(err){ errorMsg.textContent = err.message; showEmptyPhone();drawGraph([],0);}
    };
    reader.onerror = function() { errorMsg.textContent = "Không thể đọc file!"; showEmptyPhone();drawGraph([],0);}
    reader.readAsText(file,"utf-8");
  });
  function showEmptyPhone(){
    appScreen.innerHTML = `<div class="screen-content" style="background:#faf7f8;justify-content:center;"><span style="color:#eeb334;font-size:7em;opacity:.13">📱</span></div>`;
  }

  // --------- FLOW DIAGRAM SVG (event in screen box) ---------
  const SCREEN_COLOR = "#296eff", EVENT_COLOR = "#ffd93b",
        EVENT_TEXT_COLOR = "#444", SCREEN_TEXT_COLOR = "#fff",
        ARROW_COLOR = "#7eaee6", HIGHLIGHT_SCREEN="#00f1cd",
        HIGHLIGHT_EVENT="#ff6b00", EVENT_STROKE="#f3b900";

  function drawGraph(list, highlightIdx=0) {
    if (!list || list.length === 0) {graphSVG.innerHTML = "";return;}
    // Gom event theo từng screen
    const screenOrder = [], screenEventMap = {};
    list.forEach((item, idx) => {
      if(!screenEventMap[item.screen]) {
        screenOrder.push(item.screen);
        screenEventMap[item.screen] = [];
      }
      screenEventMap[item.screen].push({
        event: item.event,
        globalIdx: idx, // vị trí trong data tổng -- phục vụ highlight
      });
    });
    // Tính layout
    const screenCount = screenOrder.length;
    const colW = Math.max(125, 500/(screenCount+0.15));
    const boxW = 94, boxPadTop = 34, boxPadBottom = 28; // screen box
    const evtR = 17, evtPadY = 36, evtBoxPadSide = 11;
    // box tính toán vị trí
    const maxEvtPerScreen = Math.max(...screenOrder.map(s=>screenEventMap[s].length));
    let svgW = Math.max(500, screenCount * (boxW+evtBoxPadSide*2)+24);
    let svgH = (boxPadTop + maxEvtPerScreen*evtPadY + boxPadBottom + 15);
    // Build hashmap: event globalIdx -> (screen, pos X+Y)
    const eventNodesPos = [];
    // 1. Vẽ Screen box, gom event trong
    let svg = '';
    let screenXMap = {}; // screen: x
    screenOrder.forEach((scr, sIdx) => {
      const x = 24 + sIdx*(boxW+evtBoxPadSide*2+8);
      screenXMap[scr] = x;
      const y = boxPadTop;
      const boxH = screenEventMap[scr].length*evtPadY + boxPadTop + boxPadBottom;
      const highlightScreen = (screenEventMap[scr].some(ev=>ev.globalIdx===highlightIdx));
      // box rect
      svg += `<rect x="${x}" y="${y-boxPadTop}" width="${boxW+evtBoxPadSide*2}" height="${boxH}" rx="17"
        fill="${highlightScreen?HIGHLIGHT_SCREEN:SCREEN_COLOR}" opacity="0.21" />`;
      svg += `<rect x="${x}" y="${y-boxPadTop}" width="${boxW+evtBoxPadSide*2}" height="${boxH}" rx="17"
        fill="none" stroke="${SCREEN_COLOR}" stroke-width="2"/>`;
      // Screen label (title)
      svg += `<text x="${x+(boxW+evtBoxPadSide*2)/2}" y="${y-8}" text-anchor="middle" fill="#1836b3" font-weight="bold" font-size="1.09em">${scr}</text>`;
      // Các event trong box (theo slotY)
      screenEventMap[scr].forEach((ev, eLocalIdx) => {
        const ex = x+(boxW+evtBoxPadSide*2)/2, ey = y + evtPadY * eLocalIdx;
        eventNodesPos[ev.globalIdx] = {x: ex, y: ey, screen: scr};
        // event node
        const isCurrentEvt = (ev.globalIdx === highlightIdx);
        svg += `<circle cx="${ex}" cy="${ey}" r="${evtR}" fill="${isCurrentEvt?HIGHLIGHT_EVENT:EVENT_COLOR}"
            stroke="${isCurrentEvt?HIGHLIGHT_EVENT:EVENT_STROKE}" stroke-width="2.2"/>
            <text x="${ex}" y="${ey+5.6}" text-anchor="middle" fill="${EVENT_TEXT_COLOR}" font-size="0.98em" font-family="Montserrat">${ev.event}</text>`;
        // highlight ring?
        if(isCurrentEvt)
          svg += `<circle cx="${ex}" cy="${ey}" r="${evtR+7}" fill="none" stroke="${HIGHLIGHT_EVENT}" stroke-width="2"/>`;
      });
    });
    // 2. Vẽ arrow từ event[i] -> event[i+1]
    for(let i=0;i<list.length-1;i++) {
      const a = eventNodesPos[i], b = eventNodesPos[i+1];
      svg += drawArrow(a.x, a.y+evtR, b.x, b.y-evtR, (i+1)===highlightIdx);
    }
    // 3. Thêm nhãn Step (start/end)
    // Optional, để đơn giản ux
    //
    graphSVG.setAttribute('height', svgH);
    graphSVG.setAttribute('width', svgW);
    graphSVG.innerHTML = svg;
  }

  function drawArrow(x1, y1, x2, y2, highlight=false) {
    const len = 11;
    const color = highlight?'#e17f23':ARROW_COLOR;
    const angle = Math.atan2(y2-y1, x2-x1);
    const xA = x2 - len * Math.cos(angle - Math.PI/8);
    const yA = y2 - len * Math.sin(angle - Math.PI/8);
    const xB = x2 - len * Math.cos(angle + Math.PI/8);
    const yB = y2 - len * Math.sin(angle + Math.PI/8);
    return `
      <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${color}" stroke-width="${highlight?3:2}"/>
      <polygon points="${x2},${y2} ${xA},${yA} ${xB},${yB}" fill="${color}" />
    `;
  }
  // Lần đầu tiên, tự chạy demo
  document.getElementById('sampleBtn').click();
</script>
</body>
</html>
